@page "/textures"

@using StainManager.Blazor.WebUI.Server.Common.Models
@using StainManager.Blazor.WebUI.Server.Features.Textures.Models
@using StainManager.Blazor.WebUI.Server.Features.Textures.Services

@inject ITexturesService TexturesService

<MudDataGrid
    @ref="_dataGrid"
    T="TextureManagementModel"
    ServerData="LoadTextures"
    Hover="true"
    Striped="true"
    ColumnResizeMode="ResizeMode.Column"
    Filterable="true"
    FilterMode="DataGridFilterMode.Simple"
    Elevation="3">
    <ToolBarContent>
        <MudGrid>
            <!--#region Header & Search-->
            <MudItem xs="4">
                <MudPaper
                    Class="d-flex align-center"
                    Style="height: 48px"
                    Elevation="0">

                    <MudText Typo="Typo.h6">Textures</MudText>

                    <MudTextField
                        T="string"
                        Value="@_searchQuery"
                        ValueChanged="OnSearch"
                        Immediate="true"
                        Placeholder="Search"
                        Adornment="Adornment.Start"
                        AdornmentIcon="@Icons.Material.Filled.Search"
                        IconSize="Size.Medium"
                        Class="ml-5"/>
                </MudPaper>
            </MudItem>
            <!--#endregion Header & Search-->
            
            <MudItem xs="6"/>
            
            <!--#region Header Actions-->
            <MudItem xs="2">
                <MudPaper
                    Elevation="0"
                    Class="d-flex justify-end align-center">
                    <MudTooltip Text="@(_showDeleted ? "Hide Deleted" : "Show Deleted")">
                        <MudIconButton
                            Icon="@(_showDeleted ? Icons.Material.Filled.RemoveRedEye : Icons.Material.Outlined.RemoveRedEye)"
                            Color="@(_showDeleted ? Color.Error : Color.Default)"
                            OnClick="OnToggleShowDeleted"/>
                    </MudTooltip>

                    <MudTooltip Text="Reset">
                        <MudIconButton 
                            Icon="@Icons.Material.Filled.Loop" 
                            Color="Color.Default" 
                            OnClick="OnReset"/>
                    </MudTooltip>

                    <MudTooltip Text="Refresh">
                        <MudIconButton 
                            Icon="@Icons.Material.Filled.Refresh" 
                            Color="Color.Default" 
                            OnClick="OnRefresh"/>
                    </MudTooltip>
                    
                    <MudTooltip Text="Change Sort">
                        <MudIconButton 
                            Icon="@Icons.Material.Filled.ImportExport" 
                            Color="Color.Default" 
                            OnClick="OnChangeSort"/>
                    </MudTooltip>

                    <MudTooltip Text="Add New Species">
                        <MudIconButton
                            Icon="@Icons.Material.Filled.AddCircle"
                            Color="Color.Default"
                            OnClick="() => OpenTextureDialog()"/>
                    </MudTooltip>
                </MudPaper>
            </MudItem>
            <!--#endregion Header Actions-->
        </MudGrid>
    </ToolBarContent>

    <NoRecordsContent>
        <MudText Typo="Typo.h6">No Textures Found</MudText>
    </NoRecordsContent>

    <Columns>
        <!--#region Edit-->
        <TemplateColumn
            Title="Edit"
            CellStyle="width: 75px"
            Filterable="false">
            <CellTemplate>
                @if (!_showDeleted)
                {
                    <MudTooltip Text="Edit Species">
                        <MudFab
                            Color="Color.Secondary"
                            StartIcon="@Icons.Material.Filled.Edit"
                            Size="Size.Small"
                            OnClick="() => OpenTextureDialog(context.Item.Id)"/>
                    </MudTooltip>
                }
            </CellTemplate>
        </TemplateColumn>
        <!--#endregion Edit-->
        

        <!--#region Thumbnail-->
        <TemplateColumn
            Title="Thumbnail"
            CellStyle="width: 50px"
            Filterable="false">
            <CellTemplate>
                @{
                    var imageSrc = context.Item.ThumbnailImageLocation ?? "images/Image Coming Soon.jpg";

                    <MudImage
                        Src="@imageSrc"
                        Elevation="25"
                        Class="rounded-lg"
                        Width="75"
                        FallbackSrc="images/Image Coming Soon.jpg"/>
                }
            </CellTemplate>
        </TemplateColumn>
        <!--#endregion Thumbnail-->

        <PropertyColumn
            Property="c => c.Name"
            Filterable="true"/>
        
        <!--#region Sort Order-->
        <PropertyColumn
            Property="c => c.SortOrder"
            Filterable="false"
            Sortable="true"
            CellStyle="width: 165px;"
            Title="Sort Order"/>
        <!--#endregion Sort Order-->

        <!--#region Delete/Restore-->
        <TemplateColumn
            Title="Delete"
            CellStyle="width: 75px"
            Filterable="false">
            <CellTemplate>
                <MudTooltip Text="Delete Species">
                    <MudFab
                        Color="@(_showDeleted ? Color.Success : Color.Error)"
                        StartIcon="@(_showDeleted ? Icons.Material.Filled.RestoreFromTrash : Icons.Material.Filled.Delete)"
                        Size="Size.Small"
                        OnClick="async () =>
                        {
                            if (!_showDeleted)
                                await OpenDeleteTextureDialog(context.Item.Id);
                            else
                                await RestoreTexture(context.Item.Id);
                        }"/>
                </MudTooltip>
            </CellTemplate>
        </TemplateColumn>
        <!--#endregion Delete/Restore-->
    </Columns>

    <PagerContent>
        <MudDataGridPager T="TextureManagementModel"/>
    </PagerContent>
</MudDataGrid>

@code {
    MudDataGrid<TextureManagementModel> _dataGrid = null!;
    private bool _showDeleted;
    private string _searchQuery = string.Empty;
    
    private async Task<GridData<TextureManagementModel>> LoadTextures(
        GridState<TextureManagementModel> state)
    {
        var texturesManagement = await TexturesService.GetTexturesManagementAsync(
            _searchQuery,
            state.Page + 1, // 0-based index
            state.PageSize,
            _showDeleted,
            state.SortDefinitions.FirstOrDefault(),
            state.FilterDefinitions);

        if (texturesManagement.Failure)
        {
            Snackbar.Add(texturesManagement.GetErrorMessage("Failed to load textures"), Severity.Error);
            return new GridData<TextureManagementModel>();
        }

        return new GridData<TextureManagementModel>
        {
            TotalItems = texturesManagement.Value?.TotalCount ?? 0,
            Items = texturesManagement.Value?.Items ?? []
        };
    }

    <!--#region Toolbar Actions-->
    private Task OnSearch(string searchText)
    {
        _searchQuery = searchText;
        _dataGrid.ReloadServerData();
        return Task.CompletedTask;
    }

    private Task OnReset()
    {
        _searchQuery = string.Empty;
        _showDeleted = false;
        _dataGrid.ClearFiltersAsync();
        _dataGrid.ReloadServerData();

        return Task.CompletedTask;
    }

    private Task OnRefresh()
    {
        _dataGrid.ReloadServerData();
        return Task.CompletedTask;
    }

    private Task OnToggleShowDeleted()
    {
        _showDeleted = !_showDeleted;
        _dataGrid.ReloadServerData();
        return Task.CompletedTask;
    }
    
    <!--#region Change Sort Order-->
    private async Task OnChangeSort()
    {
        var parameters = new DialogParameters<SortOrderDialog>
        {
            { c => c.GetDropItems, LoadTexturesForSortOrder },
            { c => c.SaveSortOrder, SaveSortOrder }
        };
        var options = new DialogOptions
        {
            Position = DialogPosition.TopCenter,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };
        var dialog = await DialogService.ShowAsync<SortOrderDialog>(
            "Change Sort Order",
            parameters,
            options);
        
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
            await _dataGrid.ReloadServerData();
    }

    private async Task<Result<List<DropItem>?>> LoadTexturesForSortOrder()
    {
        var result = await TexturesService.GetTexturesSummaryAsync();
        
        if (result is { Failure: true } || result.Value is null)
            return Result.Fail<List<DropItem>?>(result.GetErrorMessage("Failed to load textures"));
        
        var dropItems = result.Value?
            .Select(x => new DropItem
            {
                Id = x.Id,
                Name = x.Name,
                SortOrder = x.SortOrder
            })
            .ToList();
        
        return Result.Ok(dropItems);
    }
    
    private async Task<Result> SaveSortOrder(List<DropItem> dropItems)
    {
        var result = await TexturesService.UpdateTexturesSortOrderAsync(dropItems);
        
        return result is { Failure: true } 
            ? Result.Fail(result.GetErrorMessage("Failed to load textures")) 
            : Result.Ok();
    }
    <!--#endregion Change Sort Order-->
    <!--#endregion Toolbar Actions-->

    <!--#region Row Actions-->
    private async Task OpenTextureDialog(int? id = null)
    {
        var parameters = new DialogParameters<TextureDialog>
        {
            { c => c.Id, id }
        };
        var options = new DialogOptions
        {
            Position = DialogPosition.TopCenter,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };
        var title = id is null
            ? "Add Texture"
            : "Edit Texture";
        var dialog = await DialogService.ShowAsync<TextureDialog>(
            title,
            parameters,
            options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
            await _dataGrid.ReloadServerData();
    }

    private async Task OpenDeleteTextureDialog(int textureId)
    {
        var parameters = new DialogParameters<DeleteTextureDialog>
        {
            { c => c.Id, textureId }
        };
        var options = new DialogOptions
        {
            Position = DialogPosition.TopCenter,
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true,
            CloseButton = true
        };
        var dialog = await DialogService.ShowAsync<DeleteTextureDialog>(
            "Delete Texture",
            parameters,
            options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
            await _dataGrid.ReloadServerData();
    }

    private async Task RestoreTexture(int textureId)
    {
        var result = await TexturesService.RestoreTextureAsync(textureId);
        
        if (result is { Failure: true })
        {
            Snackbar.Add(result.GetErrorMessage("Failed to restore texture"), Severity.Error);
            return;
        }

        await _dataGrid.ReloadServerData();
    }
    <!--#endregion Row Actions-->

}